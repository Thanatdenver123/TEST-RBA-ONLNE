<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBA Code of Conduct - HANA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Sarabun:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #f0f9ff; overflow-x: hidden; }
        .page { display: none; }
        
        /* Animations */
        .float-up { animation: floatUp 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards; opacity: 0; transform: translateY(50px); }
        .delay-1 { animation-delay: 0.2s; } .delay-2 { animation-delay: 0.4s; } .delay-3 { animation-delay: 0.6s; }
        @keyframes floatUp { to { opacity: 1; transform: translateY(0); } }
        .floating-bg { position: absolute; animation: floatHover 6s ease-in-out infinite; }
        @keyframes floatHover { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* Grid */
        .cell-doing { background-color: #fbbf24; color: white; }
        .cell-done { background-color: #cbd5e1; color: white; }
        .cell-correct { background-color: #22c55e; color: white; }
        .cell-wrong { background-color: #ef4444; color: white; }
        
        /* Loading */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            text-align: center; padding: 20px;
        }
        .spinner { border: 4px solid #e0f2fe; border-top: 4px solid #0284c7; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .trophy-gold { color: #fbbf24; } .trophy-silver { color: #94a3b8; } .trophy-bronze { color: #b45309; }
        .confetti { position: absolute; top: 0; width: 20px; height: 20px; font-size: 24px; opacity: 0; animation: fall 4s linear infinite; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

        /* Bar Chart Animation */
        .bar-fill { transition: width 1s ease-in-out; }
        
        /* Interactive Header */
        .clickable-header { cursor: pointer; transition: all 0.2s; }
        .clickable-header:hover { background-color: #e0f2fe; color: #0284c7; transform: scale(1.1); }
    </style>
</head>
<body class="text-gray-800 relative">

    <div id="app" class="w-full min-h-screen flex flex-col relative z-10">

        <!-- Loading Overlay -->
        <div id="loading-overlay">
            <div class="spinner mb-6"></div>
            <h2 class="text-sky-700 font-bold text-2xl mb-2">RBA Online</h2>
            <div id="loading-log" class="text-sm text-gray-500 mb-6 font-mono h-6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...</div>
            <button id="btn-force-reset" onclick="forceReset()" class="hidden bg-red-50 text-red-500 border border-red-200 px-6 py-3 rounded-lg hover:bg-red-100 transition font-bold shadow-sm text-sm flex items-center gap-2">
                <i class="fa-solid fa-rotate-right"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            <p class="text-xs text-gray-300 mt-8 absolute bottom-4">v6.0 Question Analytics</p>
        </div>
        
        <!-- Modal -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[10000] flex justify-center items-center">
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md text-center mx-4 transform scale-100 transition-transform">
                <div id="modal-icon" class="text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 id="modal-title" class="text-xl font-bold mb-2 text-gray-800">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                <p id="modal-message" class="text-gray-600 mb-6 text-sm"></p>
                <button id="modal-close-btn" class="w-full bg-sky-600 text-white px-4 py-3 rounded-xl hover:bg-sky-700 transition font-bold shadow-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>

        <!-- 1. Landing Page -->
        <div id="page-home" class="page w-full min-h-screen relative overflow-hidden bg-gradient-to-br from-sky-100 via-white to-blue-50 flex items-center justify-center" style="display: flex;">
            <i class="fa-solid fa-leaf text-green-200 text-9xl absolute top-20 left-10 floating-bg" style="animation-delay: 0s;"></i>
            <i class="fa-solid fa-microchip text-blue-100 text-9xl absolute bottom-20 right-10 floating-bg" style="animation-delay: 1s;"></i>
            <i class="fa-solid fa-cloud text-white text-8xl absolute top-40 right-40 floating-bg opacity-50" style="animation-delay: 2s;"></i>
            
            <div class="relative z-20 text-center max-w-4xl mx-auto px-4">
                <div class="float-up mb-8">
                    <div class="inline-flex items-center gap-3 bg-white px-6 py-3 rounded-full shadow-md border border-sky-100">
                        <i class="fa-solid fa-hospital text-sky-600 text-3xl"></i>
                        <span class="text-2xl font-extrabold tracking-widest text-gray-800">HANA</span>
                    </div>
                </div>
                <div class="flex justify-center items-end gap-4 md:gap-12 mb-8 float-up delay-1">
                    <div class="text-center"><i class="fa-solid fa-industry text-slate-400 text-6xl md:text-8xl drop-shadow-lg"></i></div>
                    <div class="text-center pb-4">
                        <h1 class="text-6xl md:text-8xl font-black text-sky-800 drop-shadow-sm tracking-tighter">RBA</h1>
                        <h2 class="text-2xl md:text-4xl font-bold text-sky-600 mt-2">Code of Conduct</h2>
                    </div>
                    <div class="text-center"><i class="fa-solid fa-leaf text-green-500 text-6xl md:text-8xl drop-shadow-lg rotate-12"></i></div>
                </div>
                <div class="float-up delay-2 mb-12">
                    <div class="flex justify-center gap-4 text-4xl md:text-6xl text-orange-400 drop-shadow-md">
                        <i class="fa-solid fa-child-reaching text-pink-400"></i><i class="fa-solid fa-child text-blue-400"></i>
                        <i class="fa-solid fa-child-dress text-purple-400"></i><i class="fa-solid fa-child text-green-400"></i>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-6 justify-center items-center float-up delay-3">
                    <button id="btn-go-teacher" class="group relative bg-white text-sky-700 px-10 py-4 rounded-full font-bold text-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 border-2 border-sky-100 overflow-hidden">
                        <span class="relative z-10"><i class="fa-solid fa-chalkboard-user mr-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π</span>
                        <div class="absolute inset-0 bg-sky-50 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></div>
                    </button>
                    <button id="btn-go-student" class="group relative bg-sky-600 text-white px-10 py-4 rounded-full font-bold text-xl shadow-lg hover:shadow-xl hover:bg-sky-700 transition-all transform hover:-translate-y-1 border-2 border-transparent">
                        <span class="relative z-10"><i class="fa-solid fa-user-graduate mr-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Teacher Dashboard -->
        <div id="page-teacher-dashboard" class="page w-full max-w-7xl mx-auto pt-6 px-4 pb-12" style="display: none;">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-sky-100 flex flex-wrap justify-between items-center gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <div class="bg-sky-100 p-3 rounded-xl text-sky-600"><i class="fa-solid fa-chart-pie text-2xl"></i></div>
                    <div><h2 class="text-2xl font-bold text-slate-800">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö RBA Monitor</h2><p class="text-slate-500 text-sm">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö: <span id="student-count" class="font-bold text-sky-600">0</span> ‡∏Ñ‡∏ô</p></div>
                </div>
                <div class="flex gap-3">
                     <button id="btn-toggle-system" class="px-6 py-2.5 rounded-xl text-white font-bold shadow-md transition bg-gray-400 hover:bg-gray-500 flex items-center gap-2">
                        <i class="fa-solid fa-power-off"></i> <span id="txt-system-status">Loading...</span>
                    </button>
                    <button onclick="window.location.reload()" class="px-4 py-2.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold transition"><i class="fa-solid fa-sign-out-alt"></i></button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left: Leaderboard -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-gradient-to-br from-blue-600 to-sky-500 rounded-2xl shadow-lg p-6 text-white">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-trophy text-yellow-300"></i> Top 5 Leaderboard</h3>
                        <div class="space-y-3" id="leaderboard-list"><div class="text-center opacity-70 py-4">‡∏£‡∏≠‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...</div></div>
                    </div>
                    <!-- Controls -->
                    <div class="bg-white rounded-2xl shadow-sm border border-sky-100 p-6">
                        <h3 class="font-bold text-slate-700 mb-4">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h3>
                        <div class="space-y-4">
                            <label class="flex items-center justify-between cursor-pointer group">
                                <span class="text-slate-600 group-hover:text-sky-600 transition">‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                                <input type="checkbox" id="toggle-names" class="w-5 h-5 accent-sky-600" checked>
                            </label>
                            <label class="flex items-center justify-between cursor-pointer group">
                                <span class="text-slate-600 group-hover:text-sky-600 transition font-bold">‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î)</span>
                                <input type="checkbox" id="toggle-answers" class="w-5 h-5 accent-green-500">
                            </label>
                            <div class="h-px bg-slate-100 my-2"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="btn-dl-excel" class="bg-emerald-500 text-white py-2 rounded-lg hover:bg-emerald-600 transition font-medium text-sm"><i class="fa-solid fa-file-excel"></i> Excel</button>
                                <button id="btn-clear-db" class="bg-red-50 text-red-500 py-2 rounded-lg hover:bg-red-100 transition font-medium text-sm"><i class="fa-solid fa-trash"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö</button>
                            </div>
                            <button id="btn-open-student-link" class="w-full border border-sky-200 text-sky-600 py-2 rounded-lg hover:bg-sky-50 transition font-medium text-sm">üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Tab ‡πÉ‡∏´‡∏°‡πà)</button>
                        </div>
                    </div>
                </div>

                <!-- Right: Grid -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-sky-100 flex flex-col overflow-hidden h-[600px]">
                    <div class="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-600 flex justify-between items-center">
                        <span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° <span class="text-xs font-normal text-slate-400 ml-2">(‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</span></span>
                        <span class="text-xs font-normal text-slate-400">Auto-update</span>
                    </div>
                    <div class="flex-1 overflow-auto p-0">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white sticky top-0 z-10 text-xs uppercase text-slate-500 shadow-sm">
                                <tr><th class="p-3 border-b w-12 text-center bg-slate-50">#</th><th class="p-3 border-b w-48 bg-slate-50">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-3 border-b w-20 text-center bg-slate-50">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-3 border-b w-16 text-center bg-slate-50 text-sky-700 font-bold">%</th></tr>
                            </thead>
                            <tbody id="grid-body" class="text-sm divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 7. Question Detail Page (New Feature v6.0) -->
        <div id="page-question-detail" class="page w-full max-w-4xl mx-auto pt-6 px-4 pb-12" style="display: none;">
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100">
                <!-- Nav -->
                <div class="flex items-center justify-between mb-6">
                    <button onclick="show('page-teacher-dashboard')" class="text-sky-600 hover:text-sky-800 font-bold flex items-center gap-2">
                        <i class="fa-solid fa-chevron-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°
                    </button>
                    <div class="flex gap-2">
                        <button id="btn-prev-q" class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="fa-solid fa-chevron-left"></i></button>
                        <span class="px-3 py-1 bg-slate-50 rounded font-bold text-slate-600">‡∏Ç‡πâ‡∏≠ <span id="detail-q-num">1</span> / 15</span>
                        <button id="btn-next-q" class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <!-- Question Content -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4 leading-relaxed" id="detail-q-text">...</h2>
                </div>

                <!-- Action Bar -->
                <div class="flex items-center gap-4 mb-6">
                    <button id="btn-toggle-detail-results" class="bg-sky-500 text-white px-6 py-2.5 rounded-lg font-bold shadow hover:bg-sky-600 transition flex items-center gap-2">
                        <span id="txt-detail-btn">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</span>
                    </button>
                    <span class="text-slate-500 text-sm"><span id="detail-answered-count">0</span> ‡∏Ñ‡∏ô ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>

                <!-- Results Bars (Hidden initially) -->
                <div id="detail-results-container" class="space-y-4 opacity-50 pointer-events-none transition-all duration-300">
                    <!-- Option True -->
                    <div class="relative">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <div id="icon-true" class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-slate-200"></div>
                                <span class="font-bold text-slate-700">‡∏ñ‡∏π‡∏Å (True)</span>
                            </div>
                            <span class="font-bold text-slate-600" id="pct-true">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-10 overflow-hidden relative">
                            <div id="bar-true" class="bar-fill bg-green-200 h-full absolute left-0 top-0 flex items-center pl-3 text-green-800 font-bold" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Option False -->
                    <div class="relative">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <div id="icon-false" class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-slate-200"></div>
                                <span class="font-bold text-slate-700">‡∏ú‡∏¥‡∏î (False)</span>
                            </div>
                            <span class="font-bold text-slate-600" id="pct-false">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-10 overflow-hidden relative">
                            <div id="bar-false" class="bar-fill bg-red-200 h-full absolute left-0 top-0 flex items-center pl-3 text-red-800 font-bold" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 bg-blue-50 rounded-lg text-sm text-blue-800 flex items-start gap-3">
                    <i class="fa-solid fa-circle-info mt-1"></i>
                    <div>
                        <p class="font-bold">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</p>
                        <p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>

            </div>
        </div>


        <!-- 3. Student Login -->
        <div id="page-student-login" class="page m-auto bg-white p-8 rounded-2xl shadow-xl max-w-md w-full mt-10 border border-sky-50" style="display: none;">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 text-3xl shadow-inner"><i class="fa-solid fa-user-graduate"></i></div>
                <h2 class="text-2xl font-bold text-slate-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</h2>
                <p class="text-slate-400 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</p>
            </div>
            <div class="space-y-5">
                <input type="text" id="student-id" class="w-full px-4 py-3.5 border-2 border-slate-100 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-500 outline-none text-center text-xl font-bold tracking-widest transition" placeholder="ID Code">
                <div id="student-preview" class="hidden bg-green-50 p-4 rounded-xl text-center border border-green-100 animate-fade-in"><p class="font-bold text-green-800 text-lg" id="preview-name"></p><p class="text-sm text-green-600" id="preview-dept"></p></div>
                <button id="btn-student-login" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-4 rounded-xl font-bold text-lg hover:shadow-lg hover:scale-[1.02] transition transform">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö <i class="fa-solid fa-arrow-right ml-2"></i></button>
                <button onclick="location.reload()" class="w-full text-slate-400 text-sm hover:text-slate-600 mt-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>

        <!-- 4. Student Exam -->
        <div id="page-student-exam" class="page m-auto bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden mt-4 flex-col h-[85vh] border border-slate-200" style="display: none;">
            <div class="bg-white p-5 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center font-bold"><i class="fa-regular fa-user"></i></div>
                    <div><h2 class="font-bold text-slate-800 text-sm" id="exam-student-name">Name</h2><p class="text-xs text-slate-500" id="exam-student-dept">Dept</p></div>
                </div>
                <div class="text-right"><span class="text-3xl font-black text-sky-600" id="q-current">1</span><span class="text-sm text-slate-400 font-medium">/15</span></div>
            </div>
            <div class="w-full bg-slate-100 h-1.5"><div id="progress-bar" class="bg-sky-500 h-1.5 transition-all duration-500" style="width: 0%"></div></div>
            <div class="flex-1 p-6 md:p-10 overflow-y-auto flex flex-col justify-center bg-slate-50">
                <div id="question-card" class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 animate-fade-in">
                    <span class="inline-block px-3 py-1 rounded-md bg-sky-100 text-sky-700 text-xs font-bold mb-4 tracking-wider">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</span>
                    <h3 class="text-xl md:text-2xl font-medium text-slate-800 mb-10 leading-relaxed" id="question-text">...</h3>
                    <div class="space-y-4">
                        <label class="flex items-center p-5 border-2 border-slate-100 rounded-xl cursor-pointer hover:bg-green-50 hover:border-green-200 transition-all group select-none" onclick="selectAnswer(true)">
                            <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center group-hover:border-green-500 mr-4 bg-white" id="radio-true"></div>
                            <span class="text-lg font-medium text-slate-600 group-hover:text-green-700">‡∏ñ‡∏π‡∏Å (True)</span>
                        </label>
                        <label class="flex items-center p-5 border-2 border-slate-100 rounded-xl cursor-pointer hover:bg-red-50 hover:border-red-200 transition-all group select-none" onclick="selectAnswer(false)">
                            <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center group-hover:border-red-500 mr-4 bg-white" id="radio-false"></div>
                            <span class="text-lg font-medium text-slate-600 group-hover:text-red-700">‡∏ú‡∏¥‡∏î (False)</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="p-5 bg-white border-t border-slate-100 flex justify-between items-center">
                <button id="btn-prev" class="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed transition flex items-center gap-2" disabled><i class="fa-solid fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button id="btn-next" class="px-8 py-3 rounded-xl font-bold bg-sky-600 text-white hover:bg-sky-700 shadow-lg hover:shadow-sky-200 transition flex items-center gap-2">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-arrow-right"></i></button>
                <button id="btn-submit" class="hidden px-8 py-3 rounded-xl font-bold bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg hover:shadow-green-200 transition transform hover:scale-105 flex items-center gap-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö <i class="fa-solid fa-check-circle"></i></button>
            </div>
        </div>

        <!-- 5. Submitted -->
        <div id="page-submitted" class="page m-auto bg-white p-12 rounded-3xl shadow-2xl text-center max-w-lg mt-10 border-4 border-green-50 relative overflow-hidden" style="display: none;">
            <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
            <div class="relative z-10">
                <div class="mb-6 text-8xl animate-bounce">üéâ</div>
                <h2 id="submit-title" class="text-3xl font-black text-slate-800 mb-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
                <p class="text-slate-500 text-lg mb-8">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                <button onclick="location.reload()" class="bg-slate-100 text-slate-600 px-8 py-3 rounded-full font-bold hover:bg-slate-200 transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            </div>
        </div>

        <!-- 6. Teacher Login -->
        <div id="page-teacher-login" class="page bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto mt-10" style="display: none;">
            <h2 class="text-2xl font-bold text-center text-sky-700 mb-6">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h2>
            <div class="space-y-4">
                <input type="password" id="teacher-room-code" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-sky-500 outline-none" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á...">
                <button id="btn-teacher-login" class="w-full bg-sky-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-sky-700 transition shadow-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button onclick="location.reload()" class="w-full text-center text-gray-600 hover:text-sky-600 transition mt-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Global Script -->
    <script>
        function forceReset() {
            if(confirm("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?")) {
                localStorage.clear(); sessionStorage.clear();
                if(navigator.serviceWorker) navigator.serviceWorker.getRegistrations().then(r => { for(let reg of r) reg.unregister(); });
                window.location.reload(true);
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, enableNetwork, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCr08U5KYGvxXu-DZ5qZOyVnU_1MJ-oY50",
            authDomain: "rba-online-6342e.firebaseapp.com",
            databaseURL: "https://rba-online-6342e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rba-online-6342e",
            storageBucket: "rba-online-6342e.firebasestorage.app",
            messagingSenderId: "50383344070",
            appId: "1:50383344070:web:5003afe4c5530fc1d5a2c7",
            measurementId: "G-G75D8551FP"
        };

        const TEACHER_CODE = "RBA";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/163RszY_6sDDQXxWiPlkw7g5HCj_U4N49H7CMCmzWPEw/export?format=csv&gid=0";
        const MASTER_QUESTIONS = [
            { t: "RBA (Responsible Business Alliance) ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏£‡∏£‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡∏ì‡πÅ‡∏´‡πà‡∏á‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", a: true },
            { t: "CORPORATE CODE OF CONDUCT ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", a: true },
            { t: "‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏ô‡πç‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á RBA ‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏π‡πâ‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å RBA", a: true },
            { t: "‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏áRBA ‡∏°‡∏µ‡∏ó‡∏±‡∏á‡πâ‡∏´‡∏°‡∏î 5 ‡∏™‡πà‡∏ß‡∏ô ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô, ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢, ‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°, ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£, ‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πç‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡πç‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î‡∏à‡∏£‡∏£‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡∏ì", a: false },
            { t: "‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏£‡πâ‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏π‡πà‡πÄ‡∏Ç‡πá‡∏ç‡∏ó‡∏≤‡∏á‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏® ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏≤‡∏à‡∏≤‡∏ï‡πà‡∏≠‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô", a: true },
            { t: "‡∏´‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πá‡∏°‡∏µ‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏Å‡πç‡∏≤‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πç‡∏≤‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô", a: true },
            { t: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∂‡∏î‡∏ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡πç‡∏≤‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå RoHS", a: true },
            { t: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏´‡∏≤‡∏Å‡∏ó‡πç‡∏≤‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πç‡∏≤‡πÄ‡∏£‡πá‡∏à‡∏•‡∏∏‡∏•‡πà‡∏ß‡∏á‡πÑ‡∏õ‡πÑ‡∏î‡πâ", a: false },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï,‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", a: true },
            { t: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏≠‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πç‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏Å‡∏è‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡πÇ‡∏ó‡∏©", a: true },
            { t: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πç‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", a: true },
            { t: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á", a: true }
        ];

        let db, auth;
        let currentStudent = null, studentCache = null, allResults = [], showAnswers = false, showNames = true;
        let configRef, studentsRef;
        let studentQuestions = [], studentAnswersMap = {}, currentQIndex = 0;
        
        // Question Detail State
        let currentDetailQuestionIndex = 0; // 0-14
        let showDetailResults = false;

        function updateLog(msg) {
            const el = document.getElementById('loading-log');
            if(el) el.textContent = msg;
        }

        async function init() {
            try {
                updateLog("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...");
                
                setTimeout(() => {
                    const overlay = document.getElementById('loading-overlay');
                    if(overlay && overlay.style.display !== 'none') {
                        updateLog("‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥...");
                        document.getElementById('btn-force-reset').classList.remove('hidden');
                    }
                }, 5000);

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                updateLog("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á...");
                configRef = doc(db, 'rba_system_config', 'main');
                studentsRef = collection(db, 'rba_students');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        updateLog("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                        setTimeout(() => {
                            document.getElementById('loading-overlay').style.display = 'none';
                            if(window.location.hash === '#student') show('page-student-login');
                        }, 500);
                    } else {
                        updateLog("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...");
                        signInAnonymously(auth).catch(e => {
                            console.error(e);
                            showError("Login Failed: " + e.message + "\n\n(Check Internet or Firebase Console)");
                            document.getElementById('btn-force-reset').classList.remove('hidden');
                        });
                    }
                });
            } catch(e) {
                showError("System Error: " + e.message);
                document.getElementById('btn-force-reset').classList.remove('hidden');
            }
        }

        const show = (id) => {
            document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'page-student-exam' || id === 'page-home') document.getElementById(id).style.display = 'flex';
        };

        const showError = (msg) => {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('modal-message').innerText = msg;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        };
        document.getElementById('modal-close-btn').onclick = () => document.getElementById('message-modal').classList.add('hidden');

        // --- ACTIONS ---
        document.getElementById('btn-go-teacher').onclick = () => show('page-teacher-login');
        document.getElementById('btn-go-student').onclick = () => show('page-student-login');
        document.querySelectorAll('.nav-home').forEach(b => b.onclick = () => location.reload());

        document.getElementById('btn-teacher-login').onclick = () => {
            if(document.getElementById('teacher-room-code').value === TEACHER_CODE) {
                show('page-teacher-dashboard');
                initTeacherDashboard();
            } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
        };

        function initTeacherDashboard() {
            // Setup Table Header
            const thead = document.querySelector('thead tr');
            while(thead.children.length > 4) thead.removeChild(thead.lastChild);
            MASTER_QUESTIONS.forEach((_, i) => {
                const th = document.createElement('th');
                th.className = "p-2 border-b text-center w-10 font-bold text-slate-400 text-xs clickable-header";
                th.innerText = i + 1;
                // Add click event for Question Detail View
                th.onclick = () => openQuestionDetail(i);
                thead.appendChild(th);
            });

            onSnapshot(configRef, (snap) => {
                const isOpen = snap.exists() ? snap.data().isOpen : false;
                const btn = document.getElementById('btn-toggle-system');
                btn.innerHTML = isOpen ? `<i class="fa-solid fa-pause"></i> ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö` : `<i class="fa-solid fa-play"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö`;
                btn.className = isOpen ? "px-6 py-2.5 rounded-xl text-white font-bold shadow-md transition bg-amber-500 hover:bg-amber-600 flex items-center gap-2" : "px-6 py-2.5 rounded-xl text-white font-bold shadow-md transition bg-emerald-500 hover:bg-emerald-600 flex items-center gap-2";
                btn.onclick = async () => await setDoc(configRef, { isOpen: !isOpen });
            });

            onSnapshot(query(studentsRef), (snap) => {
                allResults = [];
                snap.forEach(d => allResults.push(d.data()));
                renderGrid();
                updateLeaderboard();
                // If detail view is open, update it too
                if(document.getElementById('page-question-detail').style.display === 'block') {
                    renderQuestionDetail();
                }
            });

            document.getElementById('toggle-answers').onchange = (e) => { showAnswers = e.target.checked; renderGrid(); };
            document.getElementById('toggle-names').onchange = (e) => { showNames = e.target.checked; renderGrid(); };
        }

        // --- QUESTION DETAIL LOGIC ---
        function openQuestionDetail(index) {
            currentDetailQuestionIndex = index;
            showDetailResults = false; // Reset state on open
            show('page-question-detail');
            renderQuestionDetail();
        }
        
        function renderQuestionDetail() {
            const q = MASTER_QUESTIONS[currentDetailQuestionIndex];
            
            // Header Info
            document.getElementById('detail-q-num').innerText = currentDetailQuestionIndex + 1;
            document.getElementById('detail-q-text').innerText = q.t;
            
            // Calc Stats
            let trueCount = 0, falseCount = 0, totalAnswered = 0;
            allResults.forEach(s => {
                const ans = s.answers[currentDetailQuestionIndex];
                if(ans === true) trueCount++;
                if(ans === false) falseCount++;
                if(ans !== null) totalAnswered++;
            });
            
            document.getElementById('detail-answered-count').innerText = totalAnswered;
            
            // Update Button State
            const btnToggle = document.getElementById('btn-toggle-detail-results');
            const resultsContainer = document.getElementById('detail-results-container');
            
            if (showDetailResults) {
                btnToggle.innerHTML = `<i class="fa-solid fa-eye-slash"></i> ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå`;
                btnToggle.className = "bg-slate-500 text-white px-6 py-2.5 rounded-lg font-bold shadow hover:bg-slate-600 transition flex items-center gap-2";
                resultsContainer.classList.remove('opacity-50', 'pointer-events-none');
                resultsContainer.classList.add('opacity-100');
                
                // Show Correct Answer Icon
                const iconTrue = document.getElementById('icon-true');
                const iconFalse = document.getElementById('icon-false');
                
                if(q.a === true) {
                    iconTrue.className = "w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-green-500";
                    iconTrue.innerHTML = "‚úì";
                    iconFalse.className = "w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-slate-200";
                    iconFalse.innerHTML = "";
                } else {
                    iconFalse.className = "w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-green-500";
                    iconFalse.innerHTML = "‚úì";
                    iconTrue.className = "w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-slate-200";
                    iconTrue.innerHTML = "";
                }
                
                // Calc Percentages
                const pctTrue = totalAnswered > 0 ? Math.round((trueCount / totalAnswered) * 100) : 0;
                const pctFalse = totalAnswered > 0 ? Math.round((falseCount / totalAnswered) * 100) : 0;
                
                document.getElementById('pct-true').innerText = pctTrue + "%";
                document.getElementById('pct-false').innerText = pctFalse + "%";
                
                document.getElementById('bar-true').style.width = pctTrue + "%";
                document.getElementById('bar-true').innerText = trueCount > 0 ? trueCount : ""; // Show count inside bar
                
                document.getElementById('bar-false').style.width = pctFalse + "%";
                document.getElementById('bar-false').innerText = falseCount > 0 ? falseCount : "";

            } else {
                // Hidden State
                btnToggle.innerHTML = `<i class="fa-solid fa-chart-simple"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå`;
                btnToggle.className = "bg-sky-500 text-white px-6 py-2.5 rounded-lg font-bold shadow hover:bg-sky-600 transition flex items-center gap-2";
                resultsContainer.classList.add('opacity-50', 'pointer-events-none');
                resultsContainer.classList.remove('opacity-100');
                
                // Reset Bars
                document.getElementById('bar-true').style.width = "0%";
                document.getElementById('bar-false').style.width = "0%";
                document.getElementById('pct-true').innerText = "0%";
                document.getElementById('pct-false').innerText = "0%";
                document.getElementById('icon-true').className = "w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-slate-200";
                document.getElementById('icon-false').className = "w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold bg-slate-200";
            }
        }

        // Detail Page Buttons
        document.getElementById('btn-toggle-detail-results').onclick = () => {
            showDetailResults = !showDetailResults;
            renderQuestionDetail();
        };
        
        document.getElementById('btn-prev-q').onclick = () => {
            if(currentDetailQuestionIndex > 0) {
                currentDetailQuestionIndex--;
                showDetailResults = false; // Reset on change
                renderQuestionDetail();
            }
        };
        
        document.getElementById('btn-next-q').onclick = () => {
            if(currentDetailQuestionIndex < MASTER_QUESTIONS.length - 1) {
                currentDetailQuestionIndex++;
                showDetailResults = false; // Reset on change
                renderQuestionDetail();
            }
        };

        function renderGrid() {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';
            document.getElementById('student-count').innerText = allResults.length;
            allResults.sort((a,b) => (b.status === 'submitted' ? 1 : 0) - (a.status === 'submitted' ? 1 : 0));

            allResults.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-50";
                tr.innerHTML += `<td class="p-3 text-center text-slate-400 text-xs">${i+1}</td>`;
                const displayName = showNames ? s.name : `Student ${s.studentId.slice(-3)}`;
                const statusDot = s.status === 'online' ? '<span class="inline-block w-2 h-2 bg-green-400 rounded-full animate-pulse mr-2"></span>' : '';
                tr.innerHTML += `<td class="p-3"><div class="text-slate-700 font-medium text-sm">${statusDot}${displayName}</div><div class="text-xs text-slate-400">${s.dept}</div></td>`;
                let badge = s.status === 'submitted' ? `<span class="px-2 py-0.5 rounded-md bg-emerald-100 text-emerald-700 text-xs font-bold">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>` : `<span class="px-2 py-0.5 rounded-md bg-sky-100 text-sky-700 text-xs font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>`;
                tr.innerHTML += `<td class="p-3 text-center">${badge}</td>`;
                tr.innerHTML += `<td class="p-3 text-center font-bold text-slate-700 text-sm">${s.score !== null ? s.score.toFixed(0)+'%' : '-'}</td>`;
                s.answers.forEach((ans, idx) => {
                    let cls = "w-6 h-6 rounded-md mx-auto flex items-center justify-center text-[10px] font-bold transition-all ";
                    let txt = "";
                    if (ans === null) { cls += "bg-slate-100 text-slate-300"; txt="‚Ä¢"; }
                    else {
                        if(showAnswers) {
                            const isCorrect = ans === MASTER_QUESTIONS[idx].a;
                            if(isCorrect) { cls += "bg-emerald-500 text-white shadow-sm scale-110"; txt = "‚úì"; }
                            else { cls += "bg-red-500 text-white shadow-sm scale-110"; txt = "‚úï"; }
                        } else { cls += "bg-sky-500 text-white"; txt = ""; }
                    }
                    tr.innerHTML += `<td class="p-1"><div class="${cls}">${txt}</div></td>`;
                });
                tbody.appendChild(tr);
            });
        }

        function updateLeaderboard() {
            const ranked = allResults.filter(s => s.status === 'submitted').sort((a,b) => b.score - a.score || a.timeTaken - b.timeTaken).slice(0, 5);
            const div = document.getElementById('leaderboard-list');
            div.innerHTML = '';
            if(ranked.length === 0) { div.innerHTML = `<div class="text-center opacity-70 py-4 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</div>`; return; }
            ranked.forEach((s, i) => {
                let icon = `<span class="w-6 h-6 flex items-center justify-center bg-white/20 rounded text-sm font-bold">${i+1}</span>`;
                if(i===0) icon = `<i class="fa-solid fa-trophy trophy-gold"></i>`;
                if(i===1) icon = `<i class="fa-solid fa-medal trophy-silver"></i>`;
                if(i===2) icon = `<i class="fa-solid fa-medal trophy-bronze"></i>`;
                const item = document.createElement('div');
                item.className = "flex items-center justify-between bg-white/10 p-2 rounded-lg backdrop-blur-sm";
                item.innerHTML = `<div class="flex items-center gap-3">${icon}<div class="text-sm truncate max-w-[120px]" title="${s.name}">${s.name}</div></div><div class="text-right"><div class="font-bold text-yellow-300 text-sm">${s.score.toFixed(0)}%</div><div class="text-[10px] opacity-80">${s.timeTaken.toFixed(0)}s</div></div>`;
                div.appendChild(item);
            });
        }

        // --- STUDENT SYSTEM ---
        async function fetchStudents() {
            if(studentCache) return studentCache;
            try {
                const res = await fetch(SHEET_URL);
                const csv = await res.text();
                return new Promise(r => Papa.parse(csv, {header:true, skipEmptyLines:true, complete: res=>r(res.data)}));
            } catch(e) { return []; }
        }

        document.getElementById('student-id').addEventListener('input', async (e) => {
            const id = e.target.value.trim();
            const box = document.getElementById('student-preview');
            if(id.length < 3) { box.classList.add('hidden'); return; }
            const list = await fetchStudents();
            const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id);
            if(s) {
                document.getElementById('preview-name').innerText = `${s['‡∏ä‡∏∑‡πà‡∏≠']} ${s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}`;
                document.getElementById('preview-dept').innerText = s['‡πÅ‡∏ú‡∏ô‡∏Å'];
                box.classList.remove('hidden');
                studentCache = list;
            } else box.classList.add('hidden');
        });

        document.getElementById('btn-student-login').onclick = async () => {
            const id = document.getElementById('student-id').value.trim();
            if(!id) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™");
            const conf = await getDoc(configRef);
            if(!conf.exists() || !conf.data().isOpen) return alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î");
            const list = await fetchStudents();
            const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id);
            if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

            currentStudent = { id: s['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'], name: `${s['‡∏ä‡∏∑‡πà‡∏≠']} ${s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}`, dept: s['‡πÅ‡∏ú‡∏ô‡∏Å'], startTime: Date.now() };
            const existing = await getDoc(doc(studentsRef, currentStudent.id));
            if(existing.exists() && existing.data().status === 'submitted') return alert("‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");

            if(!existing.exists()) {
                 await setDoc(doc(studentsRef, currentStudent.id), {
                    studentId: currentStudent.id, name: currentStudent.name, dept: currentStudent.dept,
                    status: 'online', score: null, answers: new Array(MASTER_QUESTIONS.length).fill(null)
                });
                setupRandomQuestions();
            } else {
                setupRandomQuestions(true);
                const savedAnswers = existing.data().answers;
                studentQuestions.forEach((q, localIdx) => { studentAnswersMap[q.originalIndex] = savedAnswers[q.originalIndex]; });
            }
            document.getElementById('exam-student-name').innerText = currentStudent.name;
            document.getElementById('exam-student-dept').innerText = currentStudent.dept;
            renderQuestion();
            show('page-student-exam');
        };

        function setupRandomQuestions(restore = false) {
            let qs = MASTER_QUESTIONS.map((q, i) => ({ ...q, originalIndex: i }));
            const storageKey = `rba_order_${currentStudent.id}`;
            const savedOrder = localStorage.getItem(storageKey);

            if (savedOrder) {
                const orderIndices = JSON.parse(savedOrder);
                studentQuestions = orderIndices.map(i => qs[i]);
            } else {
                for (let i = qs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [qs[i], qs[j]] = [qs[j], qs[i]];
                }
                studentQuestions = qs;
                localStorage.setItem(storageKey, JSON.stringify(studentQuestions.map(q => q.originalIndex)));
            }
            currentQIndex = 0;
            studentAnswersMap = {};
        }

        function renderQuestion() {
            const q = studentQuestions[currentQIndex];
            document.getElementById('q-current').innerText = currentQIndex + 1;
            document.getElementById('question-text').innerText = q.t;
            const pct = ((currentQIndex) / MASTER_QUESTIONS.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('btn-prev').disabled = currentQIndex === 0;
            if(currentQIndex === studentQuestions.length - 1) {
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-submit').classList.remove('hidden');
            } else {
                document.getElementById('btn-next').classList.remove('hidden');
                document.getElementById('btn-submit').classList.add('hidden');
            }
            updateRadioVisuals(studentAnswersMap[q.originalIndex]);
        }

        window.selectAnswer = async (val) => {
            const q = studentQuestions[currentQIndex];
            studentAnswersMap[q.originalIndex] = val;
            updateRadioVisuals(val);
            const masterArray = new Array(MASTER_QUESTIONS.length).fill(null);
            for(let i=0; i<MASTER_QUESTIONS.length; i++) { if(studentAnswersMap[i] !== undefined) masterArray[i] = studentAnswersMap[i]; }
            await updateDoc(doc(studentsRef, currentStudent.id), { answers: masterArray });
        };

        function updateRadioVisuals(val) {
            const rTrue = document.getElementById('radio-true'); const rFalse = document.getElementById('radio-false');
            rTrue.className = "w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center group-hover:border-green-500 mr-4 bg-white transition"; rTrue.innerHTML = ""; rTrue.parentElement.className = "flex items-center p-5 border-2 border-slate-100 rounded-xl cursor-pointer hover:bg-green-50 hover:border-green-200 transition-all group select-none";
            rFalse.className = "w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center group-hover:border-red-500 mr-4 bg-white transition"; rFalse.innerHTML = ""; rFalse.parentElement.className = "flex items-center p-5 border-2 border-slate-100 rounded-xl cursor-pointer hover:bg-red-50 hover:border-red-200 transition-all group select-none";
            if(val === true) { rTrue.className = "w-6 h-6 rounded-full border-2 border-green-500 flex items-center justify-center mr-4 bg-green-500 text-white"; rTrue.innerHTML = "<i class='fa-solid fa-check text-xs'></i>"; rTrue.parentElement.className = "flex items-center p-5 border-2 border-green-500 bg-green-50 rounded-xl cursor-pointer transition-all group select-none shadow-sm transform scale-[1.02]"; }
            else if (val === false) { rFalse.className = "w-6 h-6 rounded-full border-2 border-red-500 flex items-center justify-center mr-4 bg-red-500 text-white"; rFalse.innerHTML = "<i class='fa-solid fa-check text-xs'></i>"; rFalse.parentElement.className = "flex items-center p-5 border-2 border-red-500 bg-red-50 rounded-xl cursor-pointer transition-all group select-none shadow-sm transform scale-[1.02]"; }
        }

        document.getElementById('btn-prev').onclick = () => { if(currentQIndex > 0) { currentQIndex--; renderQuestion(); }};
        document.getElementById('btn-next').onclick = () => { 
            const q = studentQuestions[currentQIndex];
            if(studentAnswersMap[q.originalIndex] === undefined) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
            if(currentQIndex < studentQuestions.length - 1) { currentQIndex++; renderQuestion(); }
        };
        
        document.getElementById('btn-open-student-link').onclick = () => {
            const url = window.location.href.split('#')[0] + '#student';
            const newWindow = window.open(url, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                prompt("‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Copy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:", url);
            }
        };

        document.getElementById('btn-submit').onclick = async () => {
            const q = studentQuestions[currentQIndex];
            if(studentAnswersMap[q.originalIndex] === undefined) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢");
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?")) return;
            let score = 0;
            for(let i=0; i<MASTER_QUESTIONS.length; i++) { if(studentAnswersMap[i] === MASTER_QUESTIONS[i].a) score++; }
            const finalScore = (score / MASTER_QUESTIONS.length) * 100;
            const masterArray = new Array(MASTER_QUESTIONS.length).fill(null);
            for(let i=0; i<MASTER_QUESTIONS.length; i++) { if(studentAnswersMap[i] !== undefined) masterArray[i] = studentAnswersMap[i]; }
            await updateDoc(doc(studentsRef, currentStudent.id), { answers: masterArray, score: finalScore, status: 'submitted', timeTaken: (Date.now() - currentStudent.startTime) / 1000 });
            if(finalScore === 100) { startConfetti(); document.getElementById('submit-title').innerText = "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! 100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° üèÜ"; document.getElementById('submit-title').className = "text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-4 animate-pulse"; }
            show('page-submitted');
        };

        function startConfetti() {
             const c = document.getElementById('confetti-container'); c.innerHTML = ''; const emo = ['üéâ','üå∏','üå∫','üå∑','üåª','‚≠ê','‚ú®'];
             for(let i=0; i<60; i++) { const d = document.createElement('div'); d.className = 'confetti'; d.textContent = emo[Math.floor(Math.random()*emo.length)]; d.style.left = Math.random()*100+'%'; d.style.animationDelay = Math.random()*2+'s'; d.style.animationDuration = (Math.random()*2 + 3)+'s'; c.appendChild(d); }
        }
        
        document.getElementById('btn-dl-excel').onclick = () => {
            if(allResults.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const data = allResults.map((s, i) => {
                const row = { "‡∏•‡∏≥‡∏î‡∏±‡∏ö": i+1, "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô": s.studentId, "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•": s.name, "‡πÅ‡∏ú‡∏ô‡∏Å": s.dept, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": s.status, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (%)": s.score || 0, "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏ß‡∏¥)": s.timeTaken ? s.timeTaken.toFixed(0) : '-' };
                s.answers.forEach((ans, idx) => { let res = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥"; if(ans !== null) { res = (ans === MASTER_QUESTIONS[idx].a) ? "‡∏ñ‡∏π‡∏Å" : "‡∏ú‡∏¥‡∏î"; } row[`‡∏Ç‡πâ‡∏≠ ${idx+1}`] = res; }); return row;
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Results"); XLSX.writeFile(wb, `RBA_Results_${new Date().toISOString().slice(0,10)}.xlsx`);
        };
        
        document.getElementById('btn-clear-db').onclick = async () => { if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) { const batch = writeBatch(db); const snap = await getDocs(studentsRef); snap.forEach(d => batch.delete(d.ref)); await batch.commit(); await setDoc(configRef, { isOpen: false }); alert("‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); }};

        init();
    </script>
</body>
</html>